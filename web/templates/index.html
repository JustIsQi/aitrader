<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AITrader Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <h1>AITrader Trading Dashboard</h1>
        <nav>
            <a href="/" class="active">Dashboard</a>
            <a href="/history">History</a>
            <a href="/trading">Trading</a>
        </nav>
    </header>

    <main>
        <div class="dashboard-grid-two-column">
            <!-- Left Column: Trading Signals -->
            <div class="signals-column">
            <!-- ETF Signals Module -->
            <section class="signals-panel etf-panel">
                <div class="module-header" id="etf-module-header">
                    <span class="module-title">ETF Trading Signals</span>
                    <span class="expand-icon">&#9662;</span>
                </div>

                <div id="etf-signals-container" class="signals-container">
                    {% if etf_signals_by_date %}
                        {% for date_group in etf_signals_by_date %}
                        <div class="date-group">
                            <div class="date-header">
                                <div class="date-header-content">
                                    <div class="date-title">{{ date_group.date }}</div>
                                    <div class="date-count">{{ date_group.signals|length }} signals</div>
                                </div>
                                <div class="expand-icon">&#9662;</div>
                            </div>
                            <div class="signals-list">
                                <!-- Buy Signals Table -->
                                {% set buy_signals = date_group.signals|selectattr('signal_type', 'equalto', 'buy')|list %}
                                {% if buy_signals %}
                                <div class="signals-table-wrapper buy-signals-table">
                                    <div class="signals-table-header">买入信号 ({{ buy_signals|length }})</div>
                                    <table class="signals-table">
                                        <colgroup>
                                            <col class="symbol-col">
                                            <col class="name-col">
                                            <col class="price-col">
                                            <col class="strategy-col">
                                            <col class="score-col">
                                            <col class="position-col">
                                        </colgroup>
                                        <thead>
                                            <tr>
                                                <th>代码</th>
                                                <th>名称</th>
                                                <th>价格</th>
                                                <th>策略</th>
                                                <th>得分</th>
                                                <th>持仓</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for signal in buy_signals %}
                                            <tr class="signal-row buy" data-symbol="{{ signal.symbol }}">
                                                <td class="symbol-cell">{{ signal.symbol }}</td>
                                                <td class="name-cell">{{ signal.zh_company_abbr or '-' }}</td>
                                                <td class="price-cell">{{ signal.price }}</td>
                                                <td class="strategies-cell">{{ signal.strategies }}</td>
                                                <td class="score-cell">{{ "%.4f"|format(signal.score) if signal.score is not none else '-' }}</td>
                                                <td class="position-cell">
                                                    {% if signal.position is defined and signal.position %}
                                                    <div class="position-info">
                                                        <span class="quantity">{{ "%.0f"|format(signal.position.quantity) }} 股</span>
                                                        <span class="pnl {{ 'positive' if signal.position.unrealized_pl >= 0 else 'negative' }}">
                                                            {{ "%.2f"|format(signal.position.unrealized_pl_pct) }}%
                                                        </span>
                                                    </div>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                <!-- Sell Signals Table -->
                                {% set sell_signals = date_group.signals|selectattr('signal_type', 'equalto', 'sell')|list %}
                                {% if sell_signals %}
                                <div class="signals-table-wrapper sell-signals-table">
                                    <div class="signals-table-header">卖出信号 ({{ sell_signals|length }})</div>
                                    <table class="signals-table sell-highlight">
                                        <colgroup>
                                            <col class="symbol-col">
                                            <col class="name-col">
                                            <col class="price-col">
                                            <col class="strategy-col">
                                            <col class="score-col">
                                            <col class="position-col">
                                        </colgroup>
                                        <thead>
                                            <tr>
                                                <th>代码</th>
                                                <th>名称</th>
                                                <th>价格</th>
                                                <th>策略</th>
                                                <th>得分</th>
                                                <th>持仓</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for signal in sell_signals %}
                                            <tr class="signal-row sell" data-symbol="{{ signal.symbol }}">
                                                <td class="symbol-cell">{{ signal.symbol }}</td>
                                                <td class="name-cell">{{ signal.zh_company_abbr or '-' }}</td>
                                                <td class="price-cell">{{ signal.price }}</td>
                                                <td class="strategies-cell">{{ signal.strategies }}</td>
                                                <td class="score-cell">{{ "%.4f"|format(signal.score) if signal.score is not none else '-' }}</td>
                                                <td class="position-cell">
                                                    {% if signal.position is defined and signal.position %}
                                                    <div class="position-info">
                                                        <span class="quantity">{{ "%.0f"|format(signal.position.quantity) }} 股</span>
                                                        <span class="pnl {{ 'positive' if signal.position.unrealized_pl >= 0 else 'negative' }}">
                                                            {{ "%.2f"|format(signal.position.unrealized_pl_pct) }}%
                                                        </span>
                                                    </div>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-data">No ETF signals available</p>
                    {% endif %}
                </div>
            </section>

            <!-- A-Share Weekly Signals Module -->
            <section class="signals-panel ashare-panel">
                <div class="module-header" id="ashare-weekly-module-header">
                    <span class="module-title">A-Share Weekly Strategies (A股周频策略)</span>
                    <span class="expand-icon">&#9662;</span>
                </div>

                <div id="ashare-weekly-signals-container" class="signals-container">
                    {% if ashare_weekly_signals %}
                        {% for date_group in ashare_weekly_signals %}
                        <div class="date-group">
                            <div class="date-header">
                                <div class="date-header-content">
                                    <div class="date-title">{{ date_group.date }}</div>
                                    <div class="date-count">{{ date_group.signals|length }} signals</div>
                                </div>
                                <div class="expand-icon">&#9662;</div>
                            </div>
                            <div class="signals-list">
                                <!-- Buy Signals Table -->
                                {% set buy_signals = date_group.signals|selectattr('signal_type', 'equalto', 'buy')|list %}
                                {% if buy_signals %}
                                <div class="signals-table-wrapper buy-signals-table">
                                    <div class="signals-table-header">买入信号 ({{ buy_signals|length }})</div>
                                    <table class="signals-table">
                                        <colgroup>
                                            <col class="symbol-col">
                                            <col class="name-col">
                                            <col class="price-col">
                                            <col class="strategy-col">
                                            <col class="score-col">
                                            <col class="position-col">
                                            <col class="backtest-col">
                                        </colgroup>
                                        <thead>
                                            <tr>
                                                <th>代码</th>
                                                <th>名称</th>
                                                <th>价格</th>
                                                <th>策略</th>
                                                <th>得分</th>
                                                <th>持仓</th>
                                                <th>回测</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for signal in buy_signals %}
                                            <tr class="signal-row buy" data-symbol="{{ signal.symbol }}">
                                                <td class="symbol-cell">{{ signal.symbol }}</td>
                                                <td class="name-cell">{{ signal.zh_company_abbr or '-' }}</td>
                                                <td class="price-cell">{{ signal.price }}</td>
                                                <td class="strategies-cell">{{ signal.strategies }}</td>
                                                <td class="score-cell">{{ "%.4f"|format(signal.score) if signal.score is not none else '-' }}</td>
                                                <td class="position-cell">
                                                    {% if signal.position is defined and signal.position %}
                                                    <div class="position-info">
                                                        <span class="quantity">{{ "%.0f"|format(signal.position.quantity) }} 股</span>
                                                        <span class="pnl {{ 'positive' if signal.position.unrealized_pl >= 0 else 'negative' }}">
                                                            {{ "%.2f"|format(signal.position.unrealized_pl_pct) }}%
                                                        </span>
                                                    </div>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td class="backtest-cell">
                                                    {% if signal.backtest %}
                                                    <button class="btn-view-backtest" data-backtest-id="{{ signal.backtest.id }}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                                        查看报告
                                                    </button>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                <!-- Sell Signals Table -->
                                {% set sell_signals = date_group.signals|selectattr('signal_type', 'equalto', 'sell')|list %}
                                {% if sell_signals %}
                                <div class="signals-table-wrapper sell-signals-table">
                                    <div class="signals-table-header">卖出信号 ({{ sell_signals|length }})</div>
                                    <table class="signals-table sell-highlight">
                                        <colgroup>
                                            <col class="symbol-col">
                                            <col class="name-col">
                                            <col class="price-col">
                                            <col class="strategy-col">
                                            <col class="score-col">
                                            <col class="position-col">
                                            <col class="backtest-col">
                                        </colgroup>
                                        <thead>
                                            <tr>
                                                <th>代码</th>
                                                <th>名称</th>
                                                <th>价格</th>
                                                <th>策略</th>
                                                <th>得分</th>
                                                <th>持仓</th>
                                                <th>回测</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for signal in sell_signals %}
                                            <tr class="signal-row sell" data-symbol="{{ signal.symbol }}">
                                                <td class="symbol-cell">{{ signal.symbol }}</td>
                                                <td class="name-cell">{{ signal.zh_company_abbr or '-' }}</td>
                                                <td class="price-cell">{{ signal.price }}</td>
                                                <td class="strategies-cell">{{ signal.strategies }}</td>
                                                <td class="score-cell">{{ "%.4f"|format(signal.score) if signal.score is not none else '-' }}</td>
                                                <td class="position-cell">
                                                    {% if signal.position is defined and signal.position %}
                                                    <div class="position-info">
                                                        <span class="quantity">{{ "%.0f"|format(signal.position.quantity) }} 股</span>
                                                        <span class="pnl {{ 'positive' if signal.position.unrealized_pl >= 0 else 'negative' }}">
                                                            {{ "%.2f"|format(signal.position.unrealized_pl_pct) }}%
                                                        </span>
                                                    </div>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td class="backtest-cell">
                                                    {% if signal.backtest %}
                                                    <button class="btn-view-backtest" data-backtest-id="{{ signal.backtest.id }}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                                        查看报告
                                                    </button>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-data">No A-share weekly signals available</p>
                    {% endif %}
                </div>
            </section>

            <!-- A-Share Monthly Signals Module -->
            <section class="signals-panel ashare-panel">
                <div class="module-header" id="ashare-monthly-module-header">
                    <span class="module-title">A-Share Monthly Strategies (A股月频策略)</span>
                    <span class="expand-icon">&#9662;</span>
                </div>

                <div id="ashare-monthly-signals-container" class="signals-container">
                    {% if ashare_monthly_signals %}
                        {% for date_group in ashare_monthly_signals %}
                        <div class="date-group">
                            <div class="date-header">
                                <div class="date-header-content">
                                    <div class="date-title">{{ date_group.date }}</div>
                                    <div class="date-count">{{ date_group.signals|length }} signals</div>
                                </div>
                                <div class="expand-icon">&#9662;</div>
                            </div>
                            <div class="signals-list">
                                <!-- Buy Signals Table -->
                                {% set buy_signals = date_group.signals|selectattr('signal_type', 'equalto', 'buy')|list %}
                                {% if buy_signals %}
                                <div class="signals-table-wrapper buy-signals-table">
                                    <div class="signals-table-header">买入信号 ({{ buy_signals|length }})</div>
                                    <table class="signals-table">
                                        <colgroup>
                                            <col class="symbol-col">
                                            <col class="name-col">
                                            <col class="price-col">
                                            <col class="strategy-col">
                                            <col class="score-col">
                                            <col class="position-col">
                                            <col class="backtest-col">
                                        </colgroup>
                                        <thead>
                                            <tr>
                                                <th>代码</th>
                                                <th>名称</th>
                                                <th>价格</th>
                                                <th>策略</th>
                                                <th>得分</th>
                                                <th>持仓</th>
                                                <th>回测</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for signal in buy_signals %}
                                            <tr class="signal-row buy" data-symbol="{{ signal.symbol }}">
                                                <td class="symbol-cell">{{ signal.symbol }}</td>
                                                <td class="name-cell">{{ signal.zh_company_abbr or '-' }}</td>
                                                <td class="price-cell">{{ signal.price }}</td>
                                                <td class="strategies-cell">{{ signal.strategies }}</td>
                                                <td class="score-cell">{{ "%.4f"|format(signal.score) if signal.score is not none else '-' }}</td>
                                                <td class="position-cell">
                                                    {% if signal.position is defined and signal.position %}
                                                    <div class="position-info">
                                                        <span class="quantity">{{ "%.0f"|format(signal.position.quantity) }} 股</span>
                                                        <span class="pnl {{ 'positive' if signal.position.unrealized_pl >= 0 else 'negative' }}">
                                                            {{ "%.2f"|format(signal.position.unrealized_pl_pct) }}%
                                                        </span>
                                                    </div>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td class="backtest-cell">
                                                    {% if signal.backtest %}
                                                    <button class="btn-view-backtest" data-backtest-id="{{ signal.backtest.id }}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                                        查看报告
                                                    </button>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                <!-- Sell Signals Table -->
                                {% set sell_signals = date_group.signals|selectattr('signal_type', 'equalto', 'sell')|list %}
                                {% if sell_signals %}
                                <div class="signals-table-wrapper sell-signals-table">
                                    <div class="signals-table-header">卖出信号 ({{ sell_signals|length }})</div>
                                    <table class="signals-table sell-highlight">
                                        <colgroup>
                                            <col class="symbol-col">
                                            <col class="name-col">
                                            <col class="price-col">
                                            <col class="strategy-col">
                                            <col class="score-col">
                                            <col class="position-col">
                                            <col class="backtest-col">
                                        </colgroup>
                                        <thead>
                                            <tr>
                                                <th>代码</th>
                                                <th>名称</th>
                                                <th>价格</th>
                                                <th>策略</th>
                                                <th>得分</th>
                                                <th>持仓</th>
                                                <th>回测</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for signal in sell_signals %}
                                            <tr class="signal-row sell" data-symbol="{{ signal.symbol }}">
                                                <td class="symbol-cell">{{ signal.symbol }}</td>
                                                <td class="name-cell">{{ signal.zh_company_abbr or '-' }}</td>
                                                <td class="price-cell">{{ signal.price }}</td>
                                                <td class="strategies-cell">{{ signal.strategies }}</td>
                                                <td class="score-cell">{{ "%.4f"|format(signal.score) if signal.score is not none else '-' }}</td>
                                                <td class="position-cell">
                                                    {% if signal.position is defined and signal.position %}
                                                    <div class="position-info">
                                                        <span class="quantity">{{ "%.0f"|format(signal.position.quantity) }} 股</span>
                                                        <span class="pnl {{ 'positive' if signal.position.unrealized_pl >= 0 else 'negative' }}">
                                                            {{ "%.2f"|format(signal.position.unrealized_pl_pct) }}%
                                                        </span>
                                                    </div>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td class="backtest-cell">
                                                    {% if signal.backtest %}
                                                    <button class="btn-view-backtest" data-backtest-id="{{ signal.backtest.id }}" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                                        查看报告
                                                    </button>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-data">No A-share monthly signals available</p>
                    {% endif %}
                </div>
            </section>
            </div>

            <!-- Right Column: Trading Records, Positions, P&L -->
            <div class="trading-column">
            <!-- Trading Records Module -->
            <section class="trading-panel">
                <h2>Trading Records</h2>

                <!-- Add Trading Record Form -->
                <div class="trading-form">
                    <h3>Add New Trading Record</h3>
                    <form id="tradingForm">
                        <div class="form-group">
                            <label for="symbol">Symbol:</label>
                            <input type="text" id="symbol" name="symbol" list="symbolList" required placeholder="e.g., 513100.SH" autocomplete="off">
                            <datalist id="symbolList">
                                <!-- 动态加载选项 -->
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label for="buy_sell">Type:</label>
                            <select id="buy_sell" name="buy_sell" required>
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity:</label>
                            <input type="number" id="quantity" name="quantity" required step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="price">Price:</label>
                            <input type="number" id="price" name="price" required step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label for="trade_date">Date:</label>
                            <input type="date" id="trade_date" name="trade_date" required>
                        </div>
                        <div class="form-group">
                            <label for="strategy_name">Strategy:</label>
                            <select id="strategy_name" name="strategy_name">
                                <option value="">-- Select Strategy --</option>
                            </select>
                        </div>
                        <button type="submit">Add Record</button>
                    </form>
                </div>

                <!-- Current Positions -->
                <div class="positions-section">
                    <div class="section-header">
                        <h3>Current Positions</h3>
                        <button id="recalculateBtn" class="btn-secondary">重新计算持仓</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Quantity</th>
                                <th>Avg Cost</th>
                                <th>Current Price</th>
                                <th>Market Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if positions %}
                                {% for pos in positions %}
                                <tr>
                                    <td>{{ pos.symbol }}</td>
                                    <td>{{ "%.2f"|format(pos.quantity) if pos.quantity is not none else "-" }}</td>
                                    <td>{{ "%.3f"|format(pos.avg_cost) if pos.avg_cost is not none else "-" }}</td>
                                    <td>{{ "%.3f"|format(pos.current_price) if pos.current_price is not none else "-" }}</td>
                                    <td>{{ "%.2f"|format(pos.market_value) if pos.market_value is not none else "-" }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="no-data">No positions</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Profit/Loss Summary -->
                <div class="pl-summary">
                    <div class="section-header">
                        <h3>Historical Profit/Loss Summary</h3>
                        <button id="refresh-pl-btn" class="btn-secondary">Refresh</button>
                    </div>

                    <!-- Summary Cards -->
                    <div id="pl-summary-cards" class="pl-summary-cards">
                        <div class="pl-card">
                            <span class="pl-card-label">Realized P&L</span>
                            <span id="pl-realized" class="pl-card-value">--</span>
                        </div>
                        <div class="pl-card">
                            <span class="pl-card-label">Unrealized P&L</span>
                            <span id="pl-unrealized" class="pl-card-value">--</span>
                        </div>
                        <div class="pl-card">
                            <span class="pl-card-label">Total P&L</span>
                            <span id="pl-total" class="pl-card-value">--</span>
                        </div>
                    </div>

                    <!-- Historical P&L Table -->
                    <div id="pl-table-container" class="pl-table-container">
                        <table class="data-table pl-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Bought</th>
                                    <th>Sold</th>
                                    <th>Current Holdings</th>
                                    <th>Realized P&L</th>
                                    <th>Unrealized P&L</th>
                                    <th>Total P&L</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body">
                                <tr>
                                    <td colspan="7" class="loading-cell">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            </div>
        </div>
    </main>

    <!-- Backtest Detail Modal -->
    <div id="backtest-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Backtest Report</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="backtest-modal-body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        // 确保在加载完 DOM 后执行
        window.addEventListener('DOMContentLoaded', async function() {
            const strategySelect = document.getElementById('strategy_name');
            if (!strategySelect) {
                console.error('Strategy select element not found!');
                return;
            }

            console.log('Loading strategies...');

            try {
                const response = await fetch('/api/trading/strategies');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const strategies = await response.json();
                console.log('Strategies loaded:', strategies);

                // Clear existing options (except the first one)
                strategySelect.innerHTML = '<option value="">-- Select Strategy --</option>';

                // Add strategy options
                strategies.forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy;
                    option.textContent = strategy;
                    strategySelect.appendChild(option);
                });

                console.log(`Added ${strategies.length} strategies to dropdown`);
            } catch (error) {
                console.error('Failed to load strategies:', error);
                strategySelect.innerHTML = '<option value="">Error loading strategies</option>';
            }
        });
    </script>
    <script src="/static/js/app.js"></script>
</body>
</html>
