<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AITrader Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <h1>AITrader Trading Dashboard</h1>
        <nav>
            <a href="/" class="active">Dashboard</a>
            <a href="/history">History</a>
            <a href="/trading">Trading</a>
        </nav>
    </header>

    <main>
        <div class="dashboard-grid">
            <!-- Left Module: Latest 5 Trading Days Recommendations -->
            <section class="signals-panel">
                <h2>Latest 5 Trading Days</h2>
                <div id="dashboard-signals-container">
                    {% if signals_by_date %}
                        {% for date_group in signals_by_date %}
                        <div class="date-group">
                            <div class="date-header">
                                <div class="date-header-content">
                                    <div class="date-title">{{ date_group.date }}</div>
                                    <div class="date-count">{{ date_group.signals|length }} signals</div>
                                </div>
                                <div class="expand-icon">&#9662;</div>
                            </div>
                            <div class="signals-list">
                                {% for signal in date_group.signals %}
                                <div class="signal-card {{ 'buy' if signal.signal_type == 'buy' else 'sell' }}">
                                    <div class="signal-header">
                                        <span class="symbol">{{ signal.symbol }}</span>
                                        <span class="signal-type">{{ signal.signal_type.upper() }}</span>
                                    </div>
                                    <div class="signal-details">
                                        <p>Price: {{ signal.price }}</p>
                                        <p>Strategies: {{ signal.strategies }}</p>
                                        {% if signal.score is not none %}
                                        <p>Score: {{ "%.4f"|format(signal.score) }}</p>
                                        {% endif %}
                                    </div>

                                    <!-- 持仓信息区域 -->
                                    {% if signal.position is defined and signal.position %}
                                    <div class="signal-position-info">
                                        <div class="position-header">Current Position</div>
                                        <div class="position-details">
                                            <div class="position-row">
                                                <span class="pos-label">Quantity:</span>
                                                <span class="pos-value">{{ "%.0f"|format(signal.position.quantity) }}</span>
                                            </div>
                                            <div class="position-row">
                                                <span class="pos-label">Market Value:</span>
                                                <span class="pos-value">¥{{ "%.2f"|format(signal.position.market_value) if signal.position.market_value else '-' }}</span>
                                            </div>
                                            <div class="position-row">
                                                <span class="pos-label">Unrealized P&L:</span>
                                                <span class="pos-value {{ 'positive' if signal.position.unrealized_pl >= 0 else 'negative' }}">
                                                    ¥{{ "%.2f"|format(signal.position.unrealized_pl) }}
                                                    ({{ "%.2f"|format(signal.position.unrealized_pl_pct) }}%)
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="signal-date">
                                        {{ signal.created_at }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-data">No signals available</p>
                    {% endif %}
                </div>
            </section>

            <!-- Right Module: Trading Records -->
            <section class="trading-panel">
                <h2>Trading Records</h2>

                <!-- Add Trading Record Form -->
                <div class="trading-form">
                    <h3>Add New Trading Record</h3>
                    <form id="tradingForm">
                        <div class="form-group">
                            <label for="symbol">Symbol:</label>
                            <input type="text" id="symbol" name="symbol" required placeholder="e.g., 513100.SH">
                        </div>
                        <div class="form-group">
                            <label for="buy_sell">Type:</label>
                            <select id="buy_sell" name="buy_sell" required>
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity:</label>
                            <input type="number" id="quantity" name="quantity" required step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="price">Price:</label>
                            <input type="number" id="price" name="price" required step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label for="trade_date">Date:</label>
                            <input type="date" id="trade_date" name="trade_date" required>
                        </div>
                        <div class="form-group">
                            <label for="strategy_name">Strategy:</label>
                            <select id="strategy_name" name="strategy_name">
                                <option value="">-- Select Strategy --</option>
                            </select>
                        </div>
                        <button type="submit">Add Record</button>
                    </form>
                </div>

                <!-- Current Positions -->
                <div class="positions-section">
                    <h3>Current Positions</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Quantity</th>
                                <th>Avg Cost</th>
                                <th>Current Price</th>
                                <th>Market Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if positions %}
                                {% for pos in positions %}
                                <tr>
                                    <td>{{ pos.symbol }}</td>
                                    <td>{{ "%.2f"|format(pos.quantity) if pos.quantity is not none else "-" }}</td>
                                    <td>{{ "%.3f"|format(pos.avg_cost) if pos.avg_cost is not none else "-" }}</td>
                                    <td>{{ "%.3f"|format(pos.current_price) if pos.current_price is not none else "-" }}</td>
                                    <td>{{ "%.2f"|format(pos.market_value) if pos.market_value is not none else "-" }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="no-data">No positions</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Profit/Loss Summary -->
                <div class="pl-summary">
                    <h3>Profit/Loss Summary</h3>
                    <div id="pl-container">
                        <p>Loading...</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // 确保在加载完 DOM 后执行
        window.addEventListener('DOMContentLoaded', async function() {
            const strategySelect = document.getElementById('strategy_name');
            if (!strategySelect) {
                console.error('Strategy select element not found!');
                return;
            }

            console.log('Loading strategies...');

            try {
                const response = await fetch('/api/trading/strategies');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const strategies = await response.json();
                console.log('Strategies loaded:', strategies);

                // Clear existing options (except the first one)
                strategySelect.innerHTML = '<option value="">-- Select Strategy --</option>';

                // Add strategy options
                strategies.forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy;
                    option.textContent = strategy;
                    strategySelect.appendChild(option);
                });

                console.log(`Added ${strategies.length} strategies to dropdown`);
            } catch (error) {
                console.error('Failed to load strategies:', error);
                strategySelect.innerHTML = '<option value="">Error loading strategies</option>';
            }
        });
    </script>
    <script src="/static/js/app.js"></script>
</body>
</html>
